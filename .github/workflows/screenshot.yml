name: PR Screenshot Comparison

on:
  pull_request:
    branches: [main, migration-direct, migration-component]

jobs:
  screenshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup screenshot tool
        run: |
          mkdir -p /tmp/screenshot-tool
          cd /tmp/screenshot-tool
          npm init -y
          npm install puppeteer
          cat > screenshot.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const pages = [
            { name: 'index', path: '/' },
            { name: 'profile', path: '/profile' },
            { name: 'projects', path: '/projects' },
            { name: 'projects-detail', path: '/projects/1' },
            { name: 'tasks', path: '/tasks' },
            { name: 'tasks-new', path: '/tasks/new' },
            { name: 'tasks-edit', path: '/tasks/1/edit' },
            { name: 'calendar', path: '/calendar' },
            { name: 'team', path: '/team' },
            { name: 'reports', path: '/reports' },
            { name: 'settings', path: '/settings' },
          ];

          async function takeScreenshots(outputDir) {
            fs.mkdirSync(outputDir, { recursive: true });

            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1280, height: 800 });

            for (const p of pages) {
              try {
                await page.goto(`http://localhost:3000${p.path}`, {
                  waitUntil: 'networkidle0',
                  timeout: 30000
                });
                await page.screenshot({
                  path: path.join(outputDir, `${p.name}.png`),
                  fullPage: true
                });
                console.log(`Screenshot: ${p.name}`);
              } catch (e) {
                console.error(`Failed: ${p.name} - ${e.message}`);
              }
            }

            await browser.close();
          }

          const outputDir = process.argv[2] || 'screenshots';
          takeScreenshots(outputDir);
          EOF

      - name: Install dependencies
        run: npm ci

      - name: Build and screenshot PR branch (after)
        run: |
          npm run build
          npm run start &
          sleep 15
          node /tmp/screenshot-tool/screenshot.js ${{ github.workspace }}/screenshots/after
          pkill -f "next start" || true
          sleep 3
          lsof -ti:3000 | xargs kill -9 2>/dev/null || true
          sleep 2

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          clean: false

      - name: Install dependencies for base
        run: npm ci

      - name: Build and screenshot base branch (before)
        run: |
          npm run build
          npm run start &
          sleep 15
          node /tmp/screenshot-tool/screenshot.js ${{ github.workspace }}/screenshots/before
          pkill -f "next start" || true

      - name: Create comparison images
        run: |
          mkdir -p screenshots/comparison
          for file in screenshots/after/*.png; do
            name=$(basename "$file")
            if [ -f "screenshots/before/$name" ]; then
              convert "screenshots/before/$name" "screenshots/after/$name" +append "screenshots/comparison/$name"
              echo "Created comparison: $name"
            fi
          done

      - name: Upload screenshots to branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="screenshots/pr-${{ github.event.pull_request.number }}"
          git checkout --orphan "$BRANCH_NAME"
          git rm -rf . || true

          cp -r screenshots/* .
          git add before after comparison
          git commit -m "Screenshots for PR #${{ github.event.pull_request.number }}"
          git push origin "$BRANCH_NAME" --force

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;
            const branch = `screenshots/pr-${prNumber}`;
            const baseUrl = `https://raw.githubusercontent.com/${repo.owner}/${repo.repo}/${branch}`;

            const pages = [
              'index', 'profile', 'projects', 'projects-detail',
              'tasks', 'tasks-new', 'tasks-edit',
              'calendar', 'team', 'reports', 'settings'
            ];

            let body = `## ðŸ“¸ Screenshot Comparison\n\n`;
            body += `| Page | Before | After | Comparison |\n`;
            body += `|------|--------|-------|------------|\n`;

            for (const page of pages) {
              body += `| ${page} | [before](${baseUrl}/before/${page}.png) | [after](${baseUrl}/after/${page}.png) | ![](${baseUrl}/comparison/${page}.png) |\n`;
            }

            const comments = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Screenshot Comparison')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
